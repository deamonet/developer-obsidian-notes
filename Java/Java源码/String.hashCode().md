# [ç§‘æ™®ï¼šä¸ºä»€ä¹ˆ String hashCode æ–¹æ³•é€‰æ‹©æ•°å­—31ä½œä¸ºä¹˜å­](https://segmentfault.com/a/1190000010799123)

## 1. èƒŒæ™¯

æŸå¤©ï¼Œæˆ‘åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œæ— æ„ä¸­ç‚¹å¼€äº† String hashCode æ–¹æ³•ã€‚ç„¶åå¤§è‡´çœ‹äº†ä¸€ä¸‹ hashCode çš„å®ç°ï¼Œå‘ç°å¹¶ä¸æ˜¯å¾ˆå¤æ‚ã€‚ä½†æ˜¯æˆ‘ä»æºç ä¸­å‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„æ•°å­—ï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ä¸»è§’31ã€‚è¿™ä¸ªæ•°å­—å±…ç„¶ä¸æ˜¯ç”¨å¸¸é‡å£°æ˜çš„ï¼Œæ‰€ä»¥æ²¡æ³•ä»å­—é¢æ„æ€ä¸Šæ¨æ–­è¿™ä¸ªæ•°å­—çš„ç”¨é€”ã€‚åæ¥å¸¦ç€ç–‘é—®å’Œå¥½å¥‡å¿ƒï¼Œåˆ°ç½‘ä¸Šå»æ‰¾èµ„æ–™æŸ¥è¯¢ä¸€ä¸‹ã€‚åœ¨çœ‹å®Œèµ„æ–™åï¼Œé»˜é»˜çš„æ„Ÿå¹äº†ä¸€å¥ï¼ŒåŸæ¥æ˜¯è¿™æ ·å•Šã€‚é‚£ä¹ˆåˆ°åº•æ˜¯å“ªæ ·å‘¢ï¼Ÿåœ¨æ¥ä¸‹æ¥ç« èŠ‚é‡Œï¼Œè¯·å¤§å®¶å¸¦ç€å¥½å¥‡å¿ƒå’Œæˆ‘æ­å¼€æ•°å­—31çš„ç”¨é€”ä¹‹è°œã€‚

## 2. é€‰æ‹©æ•°å­—31çš„åŸå› 

åœ¨è¯¦ç»†è¯´æ˜ String hashCode æ–¹æ³•é€‰æ‹©æ•°å­—31çš„ä½œä¸ºä¹˜å­çš„åŸå› ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ String hashCode æ–¹æ³•æ˜¯æ€æ ·å®ç°çš„ï¼Œå¦‚ä¸‹ï¼š

public int hashCode() {
    int h = hash;
    if (h == 0 && value.length > 0) {
        char val[] = value;

        for (int i = 0; i < value.length; i++) {
            h = 31 * h + val[i];
        }
        hash = h;
    }
    return h;
}

ä¸Šé¢çš„ä»£ç å°±æ˜¯ String hashCode æ–¹æ³•çš„å®ç°ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚å®é™…ä¸Š hashCode æ–¹æ³•æ ¸å¿ƒçš„è®¡ç®—é€»è¾‘åªæœ‰ä¸‰è¡Œï¼Œä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ for å¾ªç¯ã€‚æˆ‘ä»¬å¯ä»¥ç”±ä¸Šé¢çš„ for å¾ªç¯æ¨å¯¼å‡ºä¸€ä¸ªè®¡ç®—å…¬å¼ï¼ŒhashCode æ–¹æ³•æ³¨é‡Šä¸­å·²ç»ç»™å‡ºã€‚å¦‚ä¸‹ï¼š

> s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]

è¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼Œä¸Šé¢çš„ s æ•°ç»„å³æºç ä¸­çš„ val æ•°ç»„ï¼Œæ˜¯ String å†…éƒ¨ç»´æŠ¤çš„ä¸€ä¸ª char ç±»å‹æ•°ç»„ã€‚è¿™é‡Œæˆ‘æ¥ç®€å•æ¨å¯¼ä¸€ä¸‹è¿™ä¸ªå…¬å¼ï¼š

å‡è®¾ n=3
i=0 -> h = 31 * 0 + val[0]
i=1 -> h = 31 * (31 * 0 + val[0]) + val[1]
i=2 -> h = 31 * (31 * (31 * 0 + val[0]) + val[1]) + val[2]
       h = 31*31*31*0 + 31*31*val[0] + 31*val[1] + val[2]
       h = 31^(n-1)*val[0] + 31^(n-2)*val[1] + val[2]

ä¸Šé¢çš„å…¬å¼åŒ…æ‹¬å…¬å¼çš„æ¨å¯¼å¹¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œå¤§å®¶äº†è§£äº†è§£å³å¯ã€‚æ¥ä¸‹æ¥æ¥è¯´è¯´æœ¬æ–‡çš„é‡ç‚¹ï¼Œå³é€‰æ‹©31çš„ç†ç”±ã€‚ä»ç½‘ä¸Šçš„èµ„æ–™æ¥çœ‹ï¼Œä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸¤ä¸ªåŸå› ï¼š

ç¬¬ä¸€ï¼Œ31æ˜¯ä¸€ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼Œæ˜¯ä½œä¸º hashCode ä¹˜å­çš„ä¼˜é€‰è´¨æ•°ä¹‹ä¸€ã€‚å¦å¤–ä¸€äº›ç›¸è¿‘çš„è´¨æ•°ï¼Œæ¯”å¦‚37ã€41ã€43ç­‰ç­‰ï¼Œä¹Ÿéƒ½æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚é‚£ä¹ˆä¸ºå•¥ååé€‰ä¸­äº†31å‘¢ï¼Ÿè¯·çœ‹ç¬¬äºŒä¸ªåŸå› ã€‚

ç¬¬äºŒã€31å¯ä»¥è¢« JVM ä¼˜åŒ–ï¼Œ`31 * i = (i << 5) - i`ã€‚

ä¸Šé¢ä¸¤ä¸ªåŸå› ä¸­ï¼Œç¬¬ä¸€ä¸ªéœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œç¬¬äºŒä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸è¯´äº†ã€‚ä¸‹é¢æˆ‘æ¥è§£é‡Šç¬¬ä¸€ä¸ªç†ç”±ã€‚ä¸€èˆ¬åœ¨è®¾è®¡å“ˆå¸Œç®—æ³•æ—¶ï¼Œä¼šé€‰æ‹©ä¸€ä¸ªç‰¹æ®Šçš„è´¨æ•°ã€‚è‡³äºä¸ºå•¥é€‰æ‹©è´¨æ•°ï¼Œæˆ‘æƒ³åº”è¯¥æ˜¯å¯ä»¥é™ä½å“ˆå¸Œç®—æ³•çš„å†²çªç‡ã€‚è‡³äºåŸå› ï¼Œè¿™ä¸ªå°±è¦é—®æ•°å­¦å®¶äº†ï¼Œæˆ‘å‡ ä¹å¯ä»¥å¿½ç•¥çš„æ•°å­¦æ°´å¹³è§£é‡Šä¸äº†è¿™ä¸ªåŸå› ã€‚ä¸Šé¢è¯´åˆ°ï¼Œ31æ˜¯ä¸€ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼Œæ˜¯ä¼˜é€‰ä¹˜å­ã€‚é‚£ä¸ºå•¥åŒæ˜¯è´¨æ•°çš„2å’Œ101ï¼ˆæˆ–è€…æ›´å¤§çš„è´¨æ•°ï¼‰å°±ä¸æ˜¯ä¼˜é€‰ä¹˜å­å‘¢ï¼Œåˆ†æå¦‚ä¸‹ã€‚

è¿™é‡Œå…ˆåˆ†æè´¨æ•°2ã€‚é¦–å…ˆï¼Œå‡è®¾Â `n = 6`ï¼Œç„¶åæŠŠè´¨æ•°2å’Œ n å¸¦å…¥ä¸Šé¢çš„è®¡ç®—å…¬å¼ã€‚å¹¶ä»…è®¡ç®—å…¬å¼ä¸­æ¬¡æ•°æœ€é«˜çš„é‚£ä¸€é¡¹ï¼Œç»“æœæ˜¯`2^5 = 32`ï¼Œæ˜¯ä¸æ˜¯å¾ˆå°ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥æ–­å®šï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦ä¸æ˜¯å¾ˆé•¿æ—¶ï¼Œç”¨è´¨æ•°2åšä¸ºä¹˜å­ç®—å‡ºçš„å“ˆå¸Œå€¼ï¼Œæ•°å€¼ä¸ä¼šå¾ˆå¤§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå“ˆå¸Œå€¼ä¼šåˆ†å¸ƒåœ¨ä¸€ä¸ªè¾ƒå°çš„æ•°å€¼åŒºé—´å†…ï¼Œåˆ†å¸ƒæ€§ä¸ä½³ï¼Œæœ€ç»ˆå¯èƒ½ä¼šå¯¼è‡´å†²çªç‡ä¸Šå‡ã€‚

ä¸Šé¢è¯´äº†ï¼Œè´¨æ•°2åšä¸ºä¹˜å­ä¼šå¯¼è‡´å“ˆå¸Œå€¼åˆ†å¸ƒåœ¨ä¸€ä¸ªè¾ƒå°åŒºé—´å†…ï¼Œé‚£ä¹ˆå¦‚æœç”¨ä¸€ä¸ªè¾ƒå¤§çš„å¤§è´¨æ•°101ä¼šäº§ç”Ÿä»€ä¹ˆæ ·çš„ç»“æœå‘¢ï¼Ÿæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥å¯ä»¥çŒœå‡ºç»“æœäº†ã€‚å°±æ˜¯ä¸ç”¨å†æ‹…å¿ƒå“ˆå¸Œå€¼ä¼šåˆ†å¸ƒåœ¨ä¸€ä¸ªå°çš„åŒºé—´å†…äº†ï¼Œå› ä¸º`101^5 = 10,510,100,501`ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªè®¡ç®—ç»“æœå¤ªå¤§äº†ã€‚å¦‚æœç”¨ int ç±»å‹è¡¨ç¤ºå“ˆå¸Œå€¼ï¼Œç»“æœä¼šæº¢å‡ºï¼Œæœ€ç»ˆå¯¼è‡´æ•°å€¼ä¿¡æ¯ä¸¢å¤±ã€‚å°½ç®¡æ•°å€¼ä¿¡æ¯ä¸¢å¤±å¹¶ä¸ä¸€å®šä¼šå¯¼è‡´å†²çªç‡ä¸Šå‡ï¼Œä½†æ˜¯æˆ‘ä»¬æš‚ä¸”å…ˆè®¤ä¸ºè´¨æ•°101ï¼ˆæˆ–è€…æ›´å¤§çš„è´¨æ•°ï¼‰ä¹Ÿä¸æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è´¨æ•°31çš„è®¡ç®—ç»“æœï¼šÂ `31^5 = 28629151`ï¼Œç»“æœå€¼ç›¸å¯¹äº`32`å’Œ`10,510,100,501`æ¥è¯´ã€‚æ˜¯ä¸æ˜¯å¾ˆniceï¼Œä¸å¤§ä¸å°ã€‚

ä¸Šé¢ç”¨äº†æ¯”è¾ƒç®€é™‹çš„æ•°å­¦æ‰‹æ®µè¯æ˜äº†æ•°å­—31æ˜¯ä¸€ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼Œæ˜¯ä½œä¸º hashCode ä¹˜å­çš„ä¼˜é€‰è´¨æ•°ä¹‹ä¸€ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šç”¨è¯¦ç»†çš„å®éªŒæ¥éªŒè¯ä¸Šé¢çš„ç»“è®ºï¼Œä¸è¿‡åœ¨éªŒè¯å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ Stack Overflow ä¸Šå…³äºè¿™ä¸ªé—®é¢˜çš„è®¨è®ºï¼Œ[Why does Java's hashCode() in String use 31 as a multiplier?](https://link.segmentfault.com/?enc=g1MD6mnQr7ySgXPy0ATJ9Q%3D%3D.2A2xJH0x9ji0ZpoGnz%2BM0OPB86tHJqgtVwEnyi6B8gCzw%2FNicnbFW8NKApyQcRb4a8H4kbkV8f12%2Bi%2Bgn2oT8fTdNgyCPW6TAekpeWe8p4MwMFAxW4wBMtLHj8jSFBk2ZW5XCMRlrYggWJv6FCaXIw%3D%3D)ã€‚å…¶ä¸­æ’åç¬¬ä¸€çš„ç­”æ¡ˆå¼•ç”¨äº†ã€ŠEffective Javaã€‹ä¸­çš„ä¸€æ®µè¯ï¼Œè¿™é‡Œä¹Ÿå¼•ç”¨ä¸€ä¸‹ï¼š

> The value 31 was chosen because it is an odd prime. If it were even and the multiplication overflowed, information would be lost, as multiplication by 2 is equivalent to shifting. The advantage of using a prime is less clear, but it is traditional. A nice property of 31 is that the multiplication can be replaced by a shift and a subtraction for better performance:Â `31 * i == (i << 5) - i``. Modern VMs do this sort of optimization automatically.

ç®€å•ç¿»è¯‘ä¸€ä¸‹ï¼š

> é€‰æ‹©æ•°å­—31æ˜¯å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¥‡è´¨æ•°ï¼Œå¦‚æœé€‰æ‹©ä¸€ä¸ªå¶æ•°ä¼šåœ¨ä¹˜æ³•è¿ç®—ä¸­äº§ç”Ÿæº¢å‡ºï¼Œå¯¼è‡´æ•°å€¼ä¿¡æ¯ä¸¢å¤±ï¼Œå› ä¸ºä¹˜äºŒç›¸å½“äºç§»ä½è¿ç®—ã€‚é€‰æ‹©è´¨æ•°çš„ä¼˜åŠ¿å¹¶ä¸æ˜¯ç‰¹åˆ«çš„æ˜æ˜¾ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªä¼ ç»Ÿã€‚åŒæ—¶ï¼Œæ•°å­—31æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼Œå³ä¹˜æ³•è¿ç®—å¯ä»¥è¢«ç§»ä½å’Œå‡æ³•è¿ç®—å–ä»£ï¼Œæ¥è·å–æ›´å¥½çš„æ€§èƒ½ï¼š`31 * i == (i << 5) - i`ï¼Œç°ä»£çš„ Java è™šæ‹Ÿæœºå¯ä»¥è‡ªåŠ¨çš„å®Œæˆè¿™ä¸ªä¼˜åŒ–ã€‚

æ’åç¬¬äºŒçš„ç­”æ¡ˆè®¾è¿™æ ·è¯´çš„ï¼š

> As Goodrich and Tamassia point out, If you take over 50,000 English words (formed as the union of the word lists provided in two variants of Unix), using the constants 31, 33, 37, 39, and 41 will produce less than 7 collisions in each case. Knowing this, it should come as no surprise that many Java implementations choose one of these constants.

è¿™æ®µè¯ä¹Ÿç¿»è¯‘ä¸€ä¸‹ï¼š

> æ­£å¦‚ Goodrich å’Œ Tamassia æŒ‡å‡ºçš„é‚£æ ·ï¼Œå¦‚æœä½ å¯¹è¶…è¿‡ 50,000 ä¸ªè‹±æ–‡å•è¯ï¼ˆç”±ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„ Unix å­—å…¸åˆå¹¶è€Œæˆï¼‰è¿›è¡Œ hash code è¿ç®—ï¼Œå¹¶ä½¿ç”¨å¸¸æ•° 31, 33, 37, 39 å’Œ 41 ä½œä¸ºä¹˜å­ï¼Œæ¯ä¸ªå¸¸æ•°ç®—å‡ºçš„å“ˆå¸Œå€¼å†²çªæ•°éƒ½å°äº7ä¸ªï¼Œæ‰€ä»¥åœ¨ä¸Šé¢å‡ ä¸ªå¸¸æ•°ä¸­ï¼Œå¸¸æ•° 31 è¢« Java å®ç°æ‰€é€‰ç”¨ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚

ä¸Šé¢çš„ä¸¤ä¸ªç­”æ¡ˆå®Œç¾çš„è§£é‡Šäº† Java æºç ä¸­é€‰ç”¨æ•°å­— 31 çš„åŸå› ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†é’ˆå¯¹ç¬¬äºŒä¸ªç­”æ¡ˆå°±è¡ŒéªŒè¯ï¼Œè¯·å¤§å®¶ç»§ç»­å¾€ä¸‹çœ‹ã€‚

## 3. å®éªŒåŠæ•°æ®å¯è§†åŒ–

æœ¬èŠ‚ï¼Œæˆ‘å°†ä½¿ç”¨ä¸åŒçš„æ•°å­—ä½œä¸ºä¹˜å­ï¼Œå¯¹è¶…è¿‡23ä¸‡ä¸ªè‹±æ–‡å•è¯è¿›è¡Œå“ˆå¸Œè¿ç®—ï¼Œå¹¶è®¡ç®—å“ˆå¸Œç®—æ³•çš„å†²çªç‡ã€‚åŒæ—¶ï¼Œæˆ‘ä¹Ÿå°†é’ˆå¯¹ä¸åŒä¹˜å­ç®—å‡ºçš„å“ˆå¸Œå€¼åˆ†å¸ƒæƒ…å†µè¿›è¡Œå¯è§†åŒ–å¤„ç†ï¼Œè®©å¤§å®¶å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æ•°æ®åˆ†å¸ƒæƒ…å†µã€‚æœ¬æ¬¡å®éªŒæ‰€ä½¿ç”¨çš„æ•°æ®æ˜¯ Unix/Linux å¹³å°ä¸­çš„è‹±æ–‡å­—å…¸æ–‡ä»¶ï¼Œæ–‡ä»¶è·¯å¾„ä¸ºÂ `/usr/share/dict/words`ã€‚

### 3.1 å“ˆå¸Œå€¼å†²çªç‡è®¡ç®—

è®¡ç®—å“ˆå¸Œç®—æ³•å†²çªç‡å¹¶ä¸éš¾ï¼Œæ¯”å¦‚å¯ä»¥ä¸€æ¬¡æ€§å°†æ‰€æœ‰å•è¯çš„ hash code ç®—å‡ºï¼Œå¹¶æ”¾å…¥ Set ä¸­å»é™¤é‡å¤å€¼ã€‚ä¹‹åæ‹¿å•è¯æ•°å‡å» set.size() å³å¯å¾—å‡ºå†²çªæ•°ï¼Œæœ‰äº†å†²çªæ•°ï¼Œå†²çªç‡å°±å¯ä»¥ç®—å‡ºæ¥äº†ã€‚å½“ç„¶ï¼Œå¦‚æœä½¿ç”¨ JDK8 æä¾›çš„æµå¼è®¡ç®— APIï¼Œåˆ™å¯æ›´æ–¹ä¾¿ç®—å‡ºï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š

public static Integer hashCode(String str, Integer multiplier) {
    int hash = 0;
    for (int i = 0; i < str.length(); i++) {
        hash = multiplier * hash + str.charAt(i);
    }

    return hash;
}
    
/**
 * è®¡ç®— hash code å†²çªç‡ï¼Œé¡ºä¾¿åˆ†æä¸€ä¸‹ hash code æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œå¹¶è¾“å‡º
 * @param multiplier
 * @param hashs
 */
public static void calculateConflictRate(Integer multiplier, List<Integer> hashs) {
    Comparator<Integer> cp = (x, y) -> x > y ? 1 : (x < y ? -1 : 0);
    int maxHash = hashs.stream().max(cp).get();
    int minHash = hashs.stream().min(cp).get();

    // è®¡ç®—å†²çªæ•°åŠå†²çªç‡
    int uniqueHashNum = (int) hashs.stream().distinct().count();
    int conflictNum = hashs.size() - uniqueHashNum;
    double conflictRate = (conflictNum * 1.0) / hashs.size();

    System.out.println(String.format("multiplier=%4d, minHash=%11d, maxHash=%10d, conflictNum=%6d, conflictRate=%.4f%%",
                multiplier, minHash, maxHash, conflictNum, conflictRate * 100));
}

ç»“æœå¦‚ä¸‹ï¼š

![](media/1460000012913504.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨è¾ƒå°çš„è´¨æ•°åšä¸ºä¹˜å­æ—¶ï¼Œå†²çªç‡ä¼šå¾ˆé«˜ã€‚å°¤å…¶æ˜¯è´¨æ•°2ï¼Œå†²çªç‡è¾¾åˆ°äº† 55.14%ã€‚åŒæ—¶æˆ‘ä»¬æ³¨æ„è§‚å¯Ÿè´¨æ•°2ä½œä¸ºä¹˜å­æ—¶ï¼Œå“ˆå¸Œå€¼çš„åˆ†å¸ƒæƒ…å†µã€‚å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå“ˆå¸Œå€¼åˆ†å¸ƒå¹¶ä¸æ˜¯å¾ˆå¹¿ï¼Œä»…ä»…åˆ†å¸ƒåœ¨äº†æ•´ä¸ªå“ˆå¸Œç©ºé—´çš„æ­£åŠè½´éƒ¨åˆ†ï¼Œå³ 0 ~ 231-1ã€‚è€Œè´ŸåŠè½´ -231Â ~ -1ï¼Œåˆ™æ— åˆ†å¸ƒã€‚è¿™ä¹Ÿè¯æ˜äº†æˆ‘ä»¬ä¸Šé¢æ–­è¨€ï¼Œå³è´¨æ•°2ä½œä¸ºä¹˜å­æ—¶ï¼Œå¯¹äºçŸ­å­—ç¬¦ä¸²ï¼Œç”Ÿæˆçš„å“ˆå¸Œå€¼åˆ†å¸ƒæ€§ä¸ä½³ã€‚ç„¶åå†æ¥çœ‹çœ‹æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ 31ã€37ã€41 è¿™ä¸‰ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼Œè¡¨ç°éƒ½ä¸é”™ï¼Œå†²çªæ•°éƒ½ä½äº7ä¸ªã€‚è€Œè´¨æ•° 101 å’Œ 199 è¡¨ç°çš„ä¹Ÿå¾ˆä¸é”™ï¼Œå†²çªç‡å¾ˆä½ï¼Œè¿™ä¹Ÿè¯´æ˜å“ˆå¸Œå€¼æº¢å‡ºå¹¶ä¸ä¸€å®šä¼šå¯¼è‡´å†²çªç‡ä¸Šå‡ã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªå®¶ä¼™ä¸€è¨€ä¸åˆå°±æº¢å‡ºï¼Œæˆ‘ä»¬è®¤ä¸ºä»–ä»¬ä¸æ˜¯å“ˆå¸Œç®—æ³•çš„ä¼˜é€‰ä¹˜å­ã€‚æœ€åæˆ‘ä»¬å†æ¥çœ‹çœ‹ 32 å’Œ 36 è¿™ä¸¤ä¸ªå¶æ•°çš„è¡¨ç°ï¼Œç»“æœå¹¶ä¸å¥½ï¼Œå°¤å…¶æ˜¯ 32ï¼Œå†²çªç‡è¶…è¿‡äº†äº†50%ã€‚å°½ç®¡ 36 è¡¨ç°çš„è¦å¥½ä¸€ç‚¹ï¼Œä¸è¿‡å’Œ 31ï¼Œ37ç›¸æ¯”ï¼Œå†²çªç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚å½“ç„¶å¹¶éæ‰€æœ‰çš„å¶æ•°ä½œä¸ºä¹˜å­æ—¶ï¼Œå†²çªç‡éƒ½ä¼šæ¯”è¾ƒé«˜ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥è‡ªå·±éªŒè¯ã€‚

### 3.2 å“ˆå¸Œå€¼åˆ†å¸ƒå¯è§†åŒ–

ä¸Šä¸€èŠ‚åˆ†æäº†ä¸åŒæ•°å­—ä½œä¸ºä¹˜å­æ—¶çš„å†²çªç‡æƒ…å†µï¼Œè¿™ä¸€èŠ‚æ¥åˆ†æä¸€ä¸‹ä¸åŒæ•°å­—ä½œä¸ºä¹˜å­æ—¶ï¼Œå“ˆå¸Œå€¼çš„åˆ†å¸ƒæƒ…å†µã€‚åœ¨è¯¦ç»†åˆ†æä¹‹å‰ï¼Œæˆ‘å…ˆè¯´è¯´å“ˆå¸Œå€¼å¯è§†åŒ–çš„è¿‡ç¨‹ã€‚æˆ‘åŸæœ¬æ˜¯æ‰“ç®—å°†æ‰€æœ‰çš„å“ˆå¸Œå€¼ç”¨ä¸€ç»´æ•£ç‚¹å›¾è¿›è¡Œå¯è§†åŒ–ï¼Œä½†æ˜¯åæ¥æ‰¾äº†ä¸€åœˆï¼Œä¹Ÿæ²¡æ‰¾åˆ°åˆé€‚çš„ç”»å›¾å·¥å…·ã€‚åŠ ä¹‹åæ¥æƒ³äº†æƒ³ï¼Œä¸€ç»´æ•£ç‚¹å›¾å¯èƒ½ä¸åˆé€‚åšå“ˆå¸Œå€¼å¯è§†åŒ–ï¼Œå› ä¸ºè¿™é‡Œæœ‰è¶…è¿‡23ä¸‡ä¸ªå“ˆå¸Œå€¼ã€‚ä¹Ÿå°±æ„å‘³ç€ä¼šåœ¨å›¾ä¸Šæ˜¾ç¤ºè¶…è¿‡23ä¸‡ä¸ªæ•£ç‚¹ï¼Œå¦‚æœä¸å‡ºæ„å¤–çš„è¯ï¼Œè¿™23ä¸‡ä¸ªæ•£ç‚¹ä¼šèšé›†çš„å¾ˆå¯†ï¼Œæœ‰å¯èƒ½ä¼šå˜æˆä¸€ä¸ªå¤§é»‘å—ï¼Œå°±å¤±å»äº†å¯è§†åŒ–çš„æ„ä¹‰äº†ã€‚æ‰€ä»¥è¿™é‡Œé€‰æ‹©äº†å¦ä¸€ç§å¯è§†åŒ–æ•ˆæœæ›´å¥½çš„å›¾è¡¨ï¼Œä¹Ÿå°±æ˜¯ excel ä¸­çš„å¹³æ»‘æ›²çº¿çš„äºŒç»´æ•£ç‚¹å›¾ï¼ˆä¸‹é¢ç®€ç§°æ•£ç‚¹æ›²çº¿å›¾ï¼‰ã€‚å½“ç„¶è¿™é‡ŒåŒæ ·æ²¡æœ‰æŠŠ23ä¸‡æ•£ç‚¹éƒ½æ˜¾ç¤ºåœ¨å›¾è¡¨ä¸Šï¼Œå¤ªå¤šäº†ã€‚æ‰€ä»¥åœ¨å®é™…ç»˜å›¾è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°†å“ˆå¸Œç©ºé—´ç­‰åˆ†æˆäº†64ä¸ªå­åŒºé—´ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªåŒºé—´å†…çš„å“ˆå¸Œå€¼æ•°é‡ã€‚æœ€åå°†åˆ†åŒºç¼–å·åšä¸ºXè½´ï¼Œå“ˆå¸Œå€¼æ•°é‡ä¸ºYè½´ï¼Œå°±ç»˜åˆ¶å‡ºäº†æˆ‘æƒ³è¦çš„äºŒç»´æ•£ç‚¹æ›²çº¿å›¾äº†ã€‚è¿™é‡Œä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹å§ï¼Œä»¥ç¬¬0åˆ†åŒºä¸ºä¾‹ã€‚ç¬¬0åˆ†åŒºæ•°å€¼åŒºé—´æ˜¯[-2147483648, -2080374784)ï¼Œæˆ‘ä»¬ç»Ÿè®¡è½åœ¨è¯¥æ•°å€¼åŒºé—´å†…å“ˆå¸Œå€¼çš„æ•°é‡ï¼Œå¾—åˆ°Â `<åˆ†åŒºç¼–å·, å“ˆå¸Œå€¼æ•°é‡>`Â æ•°å€¼å¯¹ï¼Œè¿™æ ·å°±å¯ä»¥ç»˜å›¾äº†ã€‚åˆ†åŒºä»£ç å¦‚ä¸‹ï¼š

 /**
 * å°†æ•´ä¸ªå“ˆå¸Œç©ºé—´ç­‰åˆ†æˆ64ä»½ï¼Œç»Ÿè®¡æ¯ä¸ªç©ºé—´å†…çš„å“ˆå¸Œå€¼æ•°é‡
 * @param hashs
 */
public static Map<Integer, Integer> partition(List<Integer> hashs) {
    // step = 2^32 / 64 = 2^26
    final int step = 67108864;
    List<Integer> nums = new ArrayList<>();
    Map<Integer, Integer> statistics = new LinkedHashMap<>();
    int start = 0;
    for (long i = Integer.MIN_VALUE; i <= Integer.MAX_VALUE; i += step) {
        final long min = i;
        final long max = min + step;
        int num = (int) hashs.parallelStream()
                .filter(x -> x >= min && x < max).count();

        statistics.put(start++, num);
        nums.add(num);
    }

    // ä¸ºäº†é˜²æ­¢è®¡ç®—å‡ºé”™ï¼Œè¿™é‡ŒéªŒè¯ä¸€ä¸‹
    int hashNum = nums.stream().reduce((x, y) -> x + y).get();
    assert hashNum == hashs.size();

    return statistics;
}

æœ¬æ–‡ä¸­çš„å“ˆå¸Œå€¼æ˜¯ç”¨æ•´å½¢è¡¨ç¤ºçš„ï¼Œæ•´å½¢çš„æ•°å€¼åŒºé—´æ˜¯Â `[-2147483648, 2147483647]`ï¼ŒåŒºé—´å¤§å°ä¸ºÂ `2^32`ã€‚æ‰€ä»¥è¿™é‡Œå¯ä»¥å°†åŒºé—´ç­‰åˆ†æˆ64ä¸ªå­åŒºé—´ï¼Œæ¯ä¸ªè‡ªå­åŒºé—´å¤§å°ä¸ºÂ `2^26`ã€‚è¯¦ç»†çš„åˆ†åŒºå¯¹ç…§è¡¨å¦‚ä¸‹ï¼š

åˆ†åŒºç¼–å·

åˆ†åŒºä¸‹é™

åˆ†åŒºä¸Šé™

åˆ†åŒºç¼–å·

åˆ†åŒºä¸‹é™

åˆ†åŒºä¸Šé™

0

-2147483648

-2080374784

32

0

67108864

1

-2080374784

-2013265920

33

67108864

134217728

2

-2013265920

-1946157056

34

134217728

201326592

3

-1946157056

-1879048192

35

201326592

268435456

4

-1879048192

-1811939328

36

268435456

335544320

5

-1811939328

-1744830464

37

335544320

402653184

6

-1744830464

-1677721600

38

402653184

469762048

7

-1677721600

-1610612736

39

469762048

536870912

8

-1610612736

-1543503872

40

536870912

603979776

9

-1543503872

-1476395008

41

603979776

671088640

10

-1476395008

-1409286144

42

671088640

738197504

11

-1409286144

-1342177280

43

738197504

805306368

12

-1342177280

-1275068416

44

805306368

872415232

13

-1275068416

-1207959552

45

872415232

939524096

14

-1207959552

-1140850688

46

939524096

1006632960

15

-1140850688

-1073741824

47

1006632960

1073741824

16

-1073741824

-1006632960

48

1073741824

1140850688

17

-1006632960

-939524096

49

1140850688

1207959552

18

-939524096

-872415232

50

1207959552

1275068416

19

-872415232

-805306368

51

1275068416

1342177280

20

-805306368

-738197504

52

1342177280

1409286144

21

-738197504

-671088640

53

1409286144

1476395008

22

-671088640

-603979776

54

1476395008

1543503872

23

-603979776

-536870912

55

1543503872

1610612736

24

-536870912

-469762048

56

1610612736

1677721600

25

-469762048

-402653184

57

1677721600

1744830464

26

-402653184

-335544320

58

1744830464

1811939328

27

-335544320

-268435456

59

1811939328

1879048192

28

-268435456

-201326592

60

1879048192

1946157056

29

-201326592

-134217728

61

1946157056

2013265920

30

-134217728

-67108864

62

2013265920

2080374784

31

-67108864

0

63

2080374784

2147483648

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¯¹ç…§ä¸Šé¢çš„åˆ†åŒºè¡¨ï¼Œå¯¹æ•°å­—2ã€3ã€17ã€31ã€101çš„æ•£ç‚¹æ›²çº¿å›¾è¿›è¡Œç®€å•çš„åˆ†æã€‚å…ˆä»æ•°å­—2å¼€å§‹ï¼Œæ•°å­—2å¯¹äºçš„æ•£ç‚¹æ›²çº¿å›¾å¦‚ä¸‹ï¼š

![](media/1460000012913505.png)

ä¸Šé¢çš„å›¾è¿˜æ˜¯å¾ˆä¸€å¹•äº†ç„¶çš„ï¼Œä¹˜å­2ç®—å‡ºçš„å“ˆå¸Œå€¼å‡ ä¹å…¨éƒ¨è½åœ¨ç¬¬32åˆ†åŒºï¼Œä¹Ÿå°±æ˜¯Â `[0, 67108864)`æ•°å€¼åŒºé—´å†…ï¼Œè½åœ¨å…¶ä»–åŒºé—´å†…çš„å“ˆå¸Œå€¼æ•°é‡å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è¿™ä¹Ÿå°±ä¸éš¾è§£é‡Šä¸ºä»€ä¹ˆæ•°å­—2ä½œä¸ºä¹˜å­æ—¶ï¼Œç®—å‡ºå“ˆå¸Œå€¼çš„å†²çªç‡å¦‚æ­¤ä¹‹é«˜çš„åŸå› äº†ã€‚æ‰€ä»¥è¿™æ ·çš„å“ˆå¸Œç®—æ³•è¦å®ƒæœ‰ä½•ç”¨å•Šï¼Œæ‹–å‡ºå»æ–©äº†å§ã€‚æ¥ä¸‹æ¥çœ‹çœ‹æ•°å­—3ä½œä¸ºä¹˜å­æ—¶çš„è¡¨ç°ï¼š

![](media/1460000012913506.png)

3ä½œä¸ºä¹˜å­æ—¶ï¼Œç®—å‡ºçš„å“ˆå¸Œå€¼åˆ†å¸ƒæƒ…å†µå’Œ2å¾ˆåƒï¼Œåªä¸è¿‡ç¨å¾®å¥½äº†é‚£ä¹ˆä¸€ç‚¹ç‚¹ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºç»å¤§éƒ¨åˆ†çš„å“ˆå¸Œå€¼æœ€ç»ˆéƒ½è½åœ¨äº†ç¬¬32åˆ†åŒºé‡Œï¼Œå“ˆå¸Œå€¼çš„åˆ†å¸ƒæ€§å¾ˆå·®ã€‚è¿™ä¸ªä¹Ÿæ²¡å•¥ç”¨ï¼Œæ‹–å‡ºå»æªæ¯™5åˆ†é’Ÿå§ã€‚åœ¨çœ‹çœ‹æ•°å­—17çš„æƒ…å†µæ€ä¹ˆæ ·ï¼š

![](media/1460000012913507.png)

æ•°å­—17ä½œä¸ºä¹˜å­æ—¶çš„è¡¨ç°ï¼Œæ˜æ˜¾æ¯”ä¸Šé¢ä¸¤ä¸ªæ•°å­—å¥½ç‚¹äº†ã€‚è™½ç„¶å“ˆå¸Œå€¼åœ¨ç¬¬32åˆ†åŒºå’Œç¬¬34åˆ†åŒºæœ‰ä¸€å®šçš„èšé›†ï¼Œä½†æ˜¯ç›¸æ¯”è¾ƒä¸Šé¢2å’Œ3ï¼Œæƒ…å†µæ˜æ˜¾å¥½å¥½äº†å¾ˆå¤šã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ17ä½œä¸ºä¹˜å­ç®—å‡ºçš„å“ˆå¸Œå€¼åœ¨å…¶ä»–åŒºä¹Ÿå‡æœ‰åˆ†å¸ƒï¼Œä¸”è¾ƒä¸ºå‡åŒ€ï¼Œè¿˜ç®—æ˜¯ä¸€ä¸ªä¸é”™çš„ä¹˜å­å§ã€‚

![](media/1460000012913508.png)

æ¥ä¸‹æ¥æ¥çœ‹çœ‹æˆ‘ä»¬æœ¬æ–‡çš„ä¸»è§’31äº†ï¼Œ31ä½œä¸ºä¹˜å­ç®—å‡ºçš„å“ˆå¸Œå€¼åœ¨ç¬¬33åˆ†åŒºæœ‰ä¸€å®šçš„å°èšé›†ã€‚ä¸è¿‡ç›¸æ¯”äºæ•°å­—17ï¼Œä¸»è§’31çš„è¡¨ç°åˆå¥½äº†ä¸€äº›ã€‚é¦–å…ˆæ˜¯å“ˆå¸Œå€¼çš„èšé›†ç¨‹åº¦æ²¡æœ‰17é‚£ä¹ˆä¸¥é‡ï¼Œå…¶æ¬¡å“ˆå¸Œå€¼åœ¨å…¶ä»–åŒºåˆ†å¸ƒçš„æƒ…å†µä¹Ÿè¦å¥½äº17ã€‚æ€»ä¹‹ï¼Œé€‰31ï¼Œå‡†æ²¡é”™å•Šã€‚

![](media/1460000012913509.png)  
æœ€åå†æ¥çœ‹çœ‹å¤§è´¨æ•°101çš„è¡¨ç°ï¼Œä¸éš¾çœ‹å‡ºï¼Œè´¨æ•°101ä½œä¸ºä¹˜å­æ—¶ï¼Œç®—å‡ºçš„å“ˆå¸Œå€¼åˆ†å¸ƒæƒ…å†µè¦å¥½äºä¸»è§’31ï¼Œæœ‰ç‚¹å–§å®¾å¤ºä¸»çš„æ„æ€ã€‚ä¸è¿‡ä¸å¯å¦è®¤çš„æ˜¯ï¼Œè´¨æ•°101çš„ä½œä¸ºä¹˜å­æ—¶ï¼Œå“ˆå¸Œå€¼çš„åˆ†å¸ƒæ€§ç¡®å®æ›´åŠ å‡åŒ€ã€‚æ‰€ä»¥å¦‚æœä¸åœ¨æ„è´¨æ•°101å®¹æ˜“å¯¼è‡´æ•°æ®ä¿¡æ¯ä¸¢å¤±é—®é¢˜ï¼Œæˆ–è®¸å…¶æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚

## 4.å†™åœ¨æœ€å

ç»è¿‡ä¸Šé¢çš„åˆ†æä¸å®è·µï¼Œæˆ‘æƒ³å¤§å®¶åº”è¯¥æ˜ç™½äº† String hashCode æ–¹æ³•ä¸­é€‰æ‹©ä½¿ç”¨æ•°å­—`31`ä½œä¸ºä¹˜å­çš„åŸå› äº†ã€‚æœ¬æ–‡æœ¬è´¨æ˜¯ä¸€ç¯‡ç®€å•çš„ç§‘æ™®æ–‡è€Œå·²ï¼Œå¹¶æ²¡æœ‰é“¶å¼¹ğŸ˜ã€‚å¦‚æœå¤§å®¶è¯»å®Œåè§‰å¾—åˆæ¶¨çŸ¥è¯†äº†ï¼Œé‚£è¿™ç¯‡æ–‡ç« çš„ç›®çš„å°±è¾¾åˆ°äº†ã€‚æœ€åï¼Œæœ¬ç¯‡æ–‡ç« çš„é…å›¾ç”»çš„è¿˜æ˜¯å¾ˆè¾›è‹¦çš„ï¼Œæ‰€ä»¥å¦‚æœå¤§å®¶è§‰å¾—æ–‡ç« ä¸é”™ï¼Œä¸å¦¨å°±ç»™ä¸ªèµå§ï¼Œå°±å½“æ˜¯å¯¹æˆ‘çš„é¼“åŠ±äº†ã€‚å¦å¤–ï¼Œå¦‚æœæ–‡ç« ä¸­æœ‰ä¸å¦¥æˆ–è€…é”™è¯¯çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿æŒ‡å‡ºæ¥ã€‚å¦‚æœèƒ½ä¸åèµæ•™ï¼Œé‚£å°±æ›´å¥½äº†ã€‚æœ€åç¥å¤§å®¶ç”Ÿæ´»æ„‰å¿«ï¼Œå†è§ã€‚

> æœ¬æ–‡åœ¨çŸ¥è¯†å…±äº«è®¸å¯åè®® 4.0 ä¸‹å‘å¸ƒï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„  
> ä½œè€…ï¼šcoolblog  
> ä¸ºäº†è·å¾—æ›´å¥½çš„åˆ†ç±»é˜…è¯»ä½“éªŒï¼Œ  
> è¯·ç§»æ­¥è‡³æœ¬äººçš„ä¸ªäººåšå®¢ï¼š[http://www.coolblog.xyz](https://link.segmentfault.com/?enc=SZCBfQkAumA05EIfY7fBMw%3D%3D.5eFPX%2Fd2OaR6A05VkeWIOREmbr3x4I%2BZzUsyENTbveo%3D)

[![cc](media/cc.png)](http://creativecommons.org/licenses/by-nc-nd/4.0/)  
æœ¬ä½œå“é‡‡ç”¨[çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®](http://creativecommons.org/licenses/by-nc-nd/4.0/)è¿›è¡Œè®¸å¯ã€‚

[![](media/868271510-54cb382abb7a1_small.png)java](https://segmentfault.com/t/java)[hashcode](https://segmentfault.com/t/hashcode)[æ•°æ®å¯è§†åŒ–](https://segmentfault.com/t/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96)

é˜…è¯»Â 40.8kæ›´æ–°äºÂ 2018-06-12

èµ119æ”¶è—76

[åˆ†äº«](https://segmentfault.com/a/1190000010799123###)